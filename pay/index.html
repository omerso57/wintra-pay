<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wintra — Ödeme</title>

  <!-- ethers v5 (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    :root{
      --bg:#0a1320; --card:#0f1d30; --line:#184b63; --text:#d6f3ff; --muted:#8acbdd; --accent:#93e7ff;
      --btn:#14a1c0; --btnText:#001018;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
    .container{max-width:980px;margin:0 auto;padding:24px;}
    .nav{display:flex;justify-content:space-between;align-items:center}
    .brand{font-weight:700;letter-spacing:.5px}
    .links a{color:var(--muted);text-decoration:none;margin-left:16px}
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:16px;
      padding:24px; margin-top:24px;
    }
    h1{margin:0 0 24px}
    .row{display:flex;gap:18px;align-items:center;margin:8px 0}
    .muted{color:var(--muted)}
    .sku{display:flex;justify-content:space-between;align-items:center;border-bottom:1px dashed var(--line);padding:10px 0;margin:16px 0}
    button{
      background:var(--btn); color:var(--btnText); border:0; border-radius:12px;
      padding:12px 18px; font-weight:700; cursor:pointer
    }
    button[disabled]{opacity:.6;cursor:not-allowed}
    a.back{color:var(--accent);text-decoration:none}
    pre#msg{
      background:#08101d;border:1px dashed #184b63;border-radius:12px;
      padding:14px;white-space:pre-wrap;color:#bfeaff
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="nav">
      <div class="brand">Wintra</div>
      <div class="links"><a href="/wintra-pay/">Ana sayfa</a></div>
    </header>

    <main class="card">
      <p><a class="back" href="/wintra-pay/">← Ana sayfaya dön</a></p>
      <h1>WTR ile Satın Al</h1>

      <div class="row muted">
        Cüzdan bağla → BSC (56) → WTR ile öde → Onaydan sonra indir.
      </div>

      <div class="sku">
        <div>
          <div><strong>Ürün:</strong> Gölgelerin Ötesinde</div>
          <div class="muted"><strong>Fiyat:</strong> <span id="price">10</span> WTR</div>
        </div>
        <div>
          <button id="btn-connect">Cüzdan Bağla</button>
          <button id="btn-buy" style="display:none;">10 WTR ile Öde</button>
        </div>
      </div>

      <pre id="msg">Hazır...</pre>
    </main>

    <footer class="container muted" style="padding:16px 0;">
      © 2025 Wintra
    </footer>
  </div>

  <script>
  // ---------- Yardımcılar ----------
  const $ = (sel, root=document) => root.querySelector(sel);
  const say = (txt) => { const el = $("#msg"); if(el) el.textContent = String(txt); };

  // ---------- Konfig ----------
  const CONFIG = {
    chainIdHex: "0x38",                       // BSC Mainnet
    token:  "0xf5B1160d39dA31f0DCC0AFaA14f220dA50AF7dbf", // WTR
    seller: "0xe8db729E3B9D1263A60304A49D5d24563488aFac", // Satıcı
    priceWTR: "10",                           // 10 WTR
    readRpc: "https://rpc.ankr.com/bsc"       // Okuma için sağlam RPC
  };

  // ---------- Minimal ERC20 ABI ----------
  const ERC20_ABI = [
    "function symbol() view returns (string)",
    "function decimals() view returns (uint8)",
    "function balanceOf(address owner) view returns (uint256)",
    "function transfer(address to, uint256 amount) returns (bool)"
  ];

  // ---------- Ethers Nesneleri ----------
  let provider, signer, userAddress, token, tokenDecimals = 18, readProvider, tokenRO;

  async function ensureProvider(){
    if(typeof window.ethereum === "undefined"){
      throw new Error("MetaMask/uyumlu cüzdan gerekli.");
    }
    provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    signer   = provider.getSigner();
    return provider;
  }

  async function switchToBSC(){
    const cid = await provider.send("eth_chainId", []);
    if (cid !== CONFIG.chainIdHex){
      try{
        await provider.send("wallet_switchEthereumChain", [{ chainId: CONFIG.chainIdHex }]);
      }catch(e){
        if(e?.code === 4902){
          await provider.send("wallet_addEthereumChain", [{
            chainId: CONFIG.chainIdHex,
            chainName: "BNB Smart Chain",
            nativeCurrency:{ name:"BNB", symbol:"BNB", decimals:18 },
            // Birden fazla RPC ver (yedekli)
            rpcUrls:[
              "https://bsc-dataseed1.binance.org",
              "https://bsc-dataseed.binance.org",
              "https://rpc.ankr.com/bsc"
            ],
            blockExplorerUrls:["https://bscscan.com"]
          }]);
        }else{ throw e; }
      }
    }
  }

  function renderBuyUI(){
    $("#price").textContent = CONFIG.priceWTR;
    const buyBtn = $("#btn-buy");
    buyBtn.textContent = `${CONFIG.priceWTR} WTR ile Öde`;
    buyBtn.style.display = "inline-block";
    buyBtn.onclick = buyNow;
  }

  // ---------- Cüzdan Bağla ----------
  async function connectWallet(){
    try{
      await ensureProvider();
      const accounts = await ethereum.request({ method:"eth_requestAccounts" });
      userAddress = ethers.utils.getAddress(accounts[0]);

      await switchToBSC();

      // Okuma sağlayıcısı (MetaMask'tan bağımsız)
      readProvider = new ethers.providers.JsonRpcProvider(CONFIG.readRpc);

      // Token bu ağda var mı?
      const code = await readProvider.getCode(CONFIG.token);
      if (code === "0x") {
        throw new Error("Token bu ağda bulunmuyor (getCode=0x). Chain yanlış olabilir.");
      }

      // Sözleşmeler
      token   = new ethers.Contract(CONFIG.token, ERC20_ABI, signer);        // yazma
      tokenRO = new ethers.Contract(CONFIG.token, ERC20_ABI, readProvider);  // okuma

      // decimals (hata olursa 18'e düş)
      try {
        tokenDecimals = await tokenRO.decimals();
      } catch { tokenDecimals = 18; }

      // bakiye
      let rawBal = ethers.constants.Zero;
      try {
        rawBal = await tokenRO.balanceOf(userAddress);
      } catch (e) {
        // Bazı RPC'lerde "missing trie node" hatası olur; kullanıcıya bilgilendir
        console.warn("balanceOf uyarı:", e);
      }
      const humanBal = ethers.utils.formatUnits(rawBal, tokenDecimals);

      say(`Cüzdan bağlandı.\nAğ: BSC (56)\nWTR bakiyen: ${humanBal}`);
      const btn = $("#btn-connect");
      if(btn){ btn.textContent = "Cüzdan Bağlı"; btn.disabled = true; }

      renderBuyUI();
    }catch(e){
      // Uzun JSON-RPC stack’leri yerine özet mesaj göster
      const msg = (e?.error?.message || e?.message || String(e))
        .replace(/[\r\n]+/g,' ')
        .slice(0, 500);
      say("Bağlantı hatası: " + msg);
      console.error(e);
    }
  }

  // ---------- Ödeme ----------
  async function buyNow(){
    try{
      if(!signer) await connectWallet();

      const amount = ethers.utils.parseUnits(CONFIG.priceWTR, tokenDecimals);

      // Okumaları public RPC'den yap
      const rawBal = await tokenRO.balanceOf(userAddress);
      if(rawBal.lt(amount)){
        const have = ethers.utils.formatUnits(rawBal, tokenDecimals);
        const need = ethers.utils.formatUnits(amount, tokenDecimals);
        return say(`Yetersiz WTR bakiyesi.\nSende: ${have} WTR\nGerekli: ${need} WTR`);
      }

      // Ön kontrol — olası revert nedenlerini erken yakalayalım
      try{
        await token.callStatic.transfer(CONFIG.seller, amount);
      }catch(pre){
        const msg = (pre?.error?.message || pre?.message || String(pre)).slice(0,500);
        return say("Token transferi reddedildi (ön-kontrol). Detay: " + msg);
      }

      const tx = await token.transfer(CONFIG.seller, amount);
      say("Ödeme gönderildi. Onay bekleniyor...");
      const rec = await tx.wait(1);

      if(rec.status === 1){
        say("✅ Ödeme başarılı! (Tx: " + rec.transactionHash + ")");
        // İndirme/teşekkür sayfasını burada yönlendirebilirsin.
        // window.location.href = "/wintra-pay/public/downloads/tesekkurler.html";
      }else{
        say("⚠️ İşlem başarısız.");
      }
    }catch(e){
      const msg = (e?.error?.message || e?.message || String(e))
        .replace(/[\r\n]+/g,' ')
        .slice(0, 600);
      say("Ödeme hatası: " + msg);
      console.error(e);
    }
  }

  // ---------- Olaylar ----------
  document.addEventListener("DOMContentLoaded", ()=>{
    $("#btn-connect")?.addEventListener("click", connectWallet);
    renderBuyUI();
  });
</script>

</body>
</html>
