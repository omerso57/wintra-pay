<!doctype html>
<html lang="tr">
<head>
  <!-- THEME BOOTSTRAP (en √ºste, CSS'ten √∂nce) -->
<script>
  (function () {
    var saved = localStorage.getItem('wintra_theme');
    if (!saved) {
      try { saved = matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark'; }
      catch(e) { saved = 'dark'; }
    }
    if (saved === 'light') document.documentElement.classList.add('theme-light');
  })();
</script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wintra ‚Äî WTR ile √ñdeme</title>
  <link rel="icon" type="image/webp" href="../assets/wtr_logo.webp" />
  <style>
    :root{ --bg:#000; --text:#eaf5ff; --accent:#7df8d3; --accent-2:#a98cff; --accent-3:#dce6f0;
           --grad:linear-gradient(90deg, var(--accent), var(--accent-2), var(--accent-3));
           --mut:#9fb3c8; --border:1px solid rgba(255,255,255,.12); --card:rgba(15,20,26,.72); --radius:16px }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:500 15px/1.5 'Inter',system-ui,sans-serif;min-height:100vh}
    .spotlight{position:fixed;left:50%;top:-10vh;transform:translateX(-50%);width:140vw;height:60vh;pointer-events:none;z-index:0;
      background:radial-gradient(ellipse at center, rgba(125,248,211,.18), rgba(125,248,211,0) 60%), radial-gradient(ellipse at center, rgba(169,140,255,.12), rgba(169,140,255,0) 70%);
      filter:blur(28px) brightness(1.1)}
    .wrap{position:relative;z-index:1;max-width:980px;margin:34px auto;padding:0 18px}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .brand{display:flex;gap:10px;align-items:center;text-decoration:none;color:var(--text)}
    .logo{width:34px;height:34px;border-radius:10px;background:var(--grad);display:grid;place-items:center;color:#000;font-weight:800;border:var(--border)}
    .btn-ghost{background:transparent;color:var(--text);box-shadow:inset 0 0 0 1px rgba(200,209,218,.22);border:0;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn-cta{background:var(--grad);color:#000;border:0;border-radius:12px;padding:12px 18px;cursor:pointer;box-shadow:0 6px 18px rgba(111,240,195,.25)}
    .btn-cta[disabled]{opacity:.6;cursor:not-allowed}
    .card{background:var(--card);border:var(--border);border-radius:var(--radius);padding:22px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .badge{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:var(--border);background:rgba(255,255,255,.05)}
    .muted{color:var(--mut)}
    pre{background:#07101d;border:1px dashed #184b63;border-radius:10px;padding:12px;white-space:pre-wrap;word-break:break-word;max-height:280px;overflow:auto;color:#cbe4ff}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <div class="spotlight" aria-hidden="true"></div>
  <div class="wrap">
    <div class="header">
      <a class="brand" href="#" data-home>
        <div class="logo">W</div><strong>Wintra</strong>
      </a>
      <div class="row">
        <a class="btn-ghost" href="#" data-home>‚Üê Ana sayfa</a>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:10px">
        <h1 style="margin:0">WTR ile √ñde</h1>
        <span class="badge">BSC Mainnet ‚Ä¢ ChainId 56</span>
      </div>
      <p class="muted" style="margin:0 0 14px">C√ºzdanƒ± baƒüla ‚Üí BSC (56) ‚Üí WTR transfer ‚Üí Onaydan sonra teslim.</p>

      <div class="row" style="margin:8px 0 14px">
        <span class="badge"><strong>√úr√ºn:</strong> <span id="title">G√∂lgelerin √ñtesinde</span></span>
        <span class="badge"><strong>Fiyat:</strong> <span id="price">10</span> WTR</span>
        <span class="badge"><strong>Alƒ±cƒ±:</strong> <span id="sellerShort">‚Äî</span></span>
      </div>

      <div class="row" style="margin:10px 0 18px">
        <button class="btn-cta" id="btn-connect">C√ºzdanƒ± baƒülayƒ±n</button>
        <button class="btn-cta" id="btn-buy">WTR ile √ñde</button>
      </div>

      <pre id="log" class="muted">Hazƒ±r‚Ä¶</pre>
      <p class="muted" style="margin:10px 0 0">Onaydan sonra otomatik y√∂nlendirme: <code>thanks.html</code></p>
    </div>

    <p class="muted" style="margin:14px 4px">¬© 2025 Wintra</p>
  </div>

  <script>
  const CONFIG = {
    chainId: 56,
    token:  "0xf5B1160d39dA31f0DCC0AFaA14f220dA50AF7dbf",
    seller: "0xe8db729E3B9D1263A60304A49D5d24563488aFac",
    priceWTR: 10
  };
  const ERC20_ABI = [
    "function decimals() view returns (uint8)",
    "function balanceOf(address) view returns (uint256)",
    "function transfer(address to, uint256 amount) returns (bool)"
  ];
  const $   = (q)=>document.querySelector(q);
  const log = $("#log");
  const say = (t)=>{ log.textContent = String(t); };
  const add = (t)=>{ log.textContent += "\\n" + String(t); };

  let provider, signer, user, token, tokenDecimals, amountWTR, memo;
  function fmtAddr(a){ return a ? a.slice(0,6) + "‚Ä¶" + a.slice(-4) : "‚Äî"; }
  function fmtNum(v, d=4){ try{ return Number(v).toLocaleString("tr-TR",{maximumFractionDigits:d}); }catch{ return String(v) } }

  (function readQuery(){
    const qs = new URLSearchParams(location.search);
    amountWTR = Number(qs.get("amount") || CONFIG.priceWTR);
    memo = qs.get("memo") || "";
    $("#price").textContent = String(amountWTR);
    $("#sellerShort").textContent = fmtAddr(CONFIG.seller);
  })();

  async function ensureProvider(){
    if(!window.ethereum){ say("MetaMask gerekli. L√ºtfen kurun."); throw new Error("no-metamask"); }
    const web3 = new ethers.providers.Web3Provider(window.ethereum, "any");
    provider = web3; signer = web3.getSigner(); return web3;
  }
  async function switchToBSC(){
    const hex = "0x" + CONFIG.chainId.toString(16);
    try{ await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId: hex }]}); }
    catch(e){
      if(e && e.code === 4902){
        await window.ethereum.request({ method:"wallet_addEthereumChain", params:[{
          chainId: hex, chainName:"BNB Smart Chain",
          nativeCurrency:{ name:"BNB", symbol:"BNB", decimals:18 },
          rpcUrls:["https://bsc-dataseed.binance.org","https://rpc.ankr.com/bsc","https://bsc.publicnode.com"],
          blockExplorerUrls:["https://bscscan.com"]
        }]});
      } else { throw e; }
    }
  }
  async function connectWallet(){
    try{
      say("C√ºzdan baƒülanƒ±yor‚Ä¶");
      await ensureProvider();
      const accounts = await window.ethereum.request({ method:"eth_requestAccounts" });
      user = ethers.utils.getAddress(accounts[0]);
      await switchToBSC();
      token = new ethers.Contract(CONFIG.token, ERC20_ABI, signer);
      tokenDecimals = await token.decimals();
      $("#btn-connect").textContent = "C√ºzdan baƒülƒ±"; $("#btn-connect").disabled = true;
      say(`Baƒülandƒ± ‚úÖ\\nHesap: ${user}\\nAƒü: BSC (56)\\nToken: ${CONFIG.token}`);
    }catch(err){ console.error(err); say("Baƒülantƒ± hatasƒ±: " + (err?.message||err)); }
  }
  async function buyNow(){
    try{
      if(!signer) throw new Error("L√ºtfen √∂nce c√ºzdanƒ± baƒülayƒ±n.");
      const net = await provider.getNetwork();
      if(Number(net.chainId) !== Number(CONFIG.chainId)) await switchToBSC();
      const need = ethers.utils.parseUnits(String(amountWTR), tokenDecimals || 18);
      const bal  = await token.balanceOf(user);
      if(bal.lt(need)) throw new Error(`Yetersiz WTR. Gerekli: ${fmtNum(ethers.utils.formatUnits(need, tokenDecimals||18))} WTR`);
      say("ƒ∞≈ülem hazƒ±rlanƒ±yor‚Ä¶ MetaMask onayƒ± bekleniyor.");
      const tx = await token.transfer(CONFIG.seller, need);
      say("ƒ∞≈ülem g√∂nderildi. Onay bekleniyor‚Ä¶\\nTx: " + tx.hash);
      const rec = await tx.wait();
      add("Onay: " + rec.transactionHash);
      add("‚úÖ √ñdeme ba≈üarƒ±lƒ±. Y√∂nlendiriliyor‚Ä¶");
      const back = `thanks.html?paid=1&tx=${tx.hash}${memo ? `&memo=${encodeURIComponent(memo)}` : ""}`;
      location.href = back;
    }catch(err){ console.error(err); say("√ñdeme hatasƒ±: " + (err?.message||err)); }
  }
  $("#btn-connect").addEventListener("click", connectWallet);
  $("#btn-buy").addEventListener("click", buyNow);

  // üîß BASE PATH FIX ‚Äî ana sayfa linkleri
  (function fixBase(){
    let base = '/';
    const parts = location.pathname.split('/').filter(Boolean);
    if (location.hostname.endsWith('github.io') && parts.length > 0) {
      base = '/' + parts[0] + '/';
    }
    document.querySelectorAll('[data-home]').forEach(a => a.setAttribute('href', base + 'index.html'));
  })();
  </script>
</body>
</html>
