<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wintra — Ödeme</title>
  <link rel="icon" href="../assets/wtr.png" />
  <style>
    :root{--bg:#0a1320;--card:#0f1d30;--acc:#93e7ff;--mut:#a8cbbd;--btn:#14a1c0;--btnTxt:#001018;--ok:#23d18b}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:#e8f6ff;font-family:system-ui,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:980px;margin:40px auto;padding:0 20px}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    a,button{font-weight:600}
    a{color:var(--acc);text-decoration:none}
    .card{background:var(--card);border:1px solid #184b63;border-radius:16px;padding:24px 24px 8px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{background:var(--btn);color:var(--btnTxt);border:0;border-radius:12px;padding:12px 18px;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .muted{color:var(--mut)}
    pre{background:#07101d;border:1px dashed #184b63;border-radius:10px;padding:12px;white-space:pre-wrap;word-break:break-word;max-height:280px;overflow:auto}
    .tag{display:inline-flex;gap:6px;align-items:center;background:#09182a;border:1px solid #14344a;border-radius:999px;padding:6px 10px;margin:6px 6px 0 0}
    .ok{color:var(--ok)}
  </style>
  <!-- ethers v5 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <a href="../index.html">← Ana sayfaya dön</a>
      <div class="muted">Wintra</div>
    </div>

    <div class="card">
      <h1 style="margin:0 0 10px 0">WTR ile Satın Al</h1>
      <div class="muted" style="margin-bottom:16px">Cüzdan bağla → BSC (56) → WTR ile öde → Onaydan sonra indir.</div>

      <div class="row" style="margin:12px 0 14px">
        <div class="tag"><strong>Ürün:</strong> Gölgelerin Ötesinde</div>
        <div class="tag"><strong>Fiyat:</strong> <span id="price">10</span> WTR</div>
        <div class="tag"><strong>Ağ:</strong> BSC Mainnet (56)</div>
      </div>

      <div class="row" style="margin:10px 0 18px">
        <button class="btn" id="btn-connect">Cüzdan Bağla</button>
        <button class="btn" id="btn-buy">10 WTR ile Öde</button>
      </div>

      <pre id="log" class="muted">Hazır…</pre>
      <div class="muted" style="margin:10px 0 12px">
        Not: İşlem onaylandıktan sonra indirme bağlantısı otomatik açılır.
      </div>
    </div>

    <p class="muted" style="margin:14px 4px">© 2025 Wintra</p>
  </div>

  <script>
  /******************
   *  K O N F İ G   *
   ******************/
  const CONFIG = {
    chainId: 56,                                                // BSC Mainnet
    token: "0xf5B1160d39dA31f0DCC0AFaA14f220dA50AF7dbf",        // WTR (BEP-20)
    seller: "0xe8db729E3B9D1263A60304A49D5d24563488aFac",       // Satıcı cüzdanı
    priceWTR: 10                                                // ürün fiyatı (WTR)
  };

  // Minimal ERC-20 ABI (decimals/balanceOf/transfer)
  const ERC20_ABI = [
    "function decimals() view returns (uint8)",
    "function balanceOf(address) view returns (uint256)",
    "function transfer(address to, uint256 amount) returns (bool)"
  ];

  /******************
   *  A R A Ç L A R *
   ******************/
  const $ = (q) => document.querySelector(q);
  const logBox = $("#log");
  const say = (t) => { logBox.textContent = String(t); };
  const add = (t) => { logBox.textContent += "\n" + String(t); };

  let provider, web3Provider, signer, user, token, tokenDecimals;

  function hasMM(){
    if(!window.ethereum){ say("MetaMask bulunamadı. Lütfen MetaMask kur."); return false; }
    return true;
  }

  async function ensureProvider(){
    if(!hasMM()) throw new Error("no-metamask");
    web3Provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    signer = web3Provider.getSigner();
    provider = web3Provider; // kısayol
  }

  async function switchToBSC(){
    // chainId hex ister
    const hex = "0x" + CONFIG.chainId.toString(16);
    try{
      await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId: hex }]});
    }catch(e){
      // Ağ ekli değilse eklemeyi dene
      if(e && e.code === 4902){
        await window.ethereum.request({
          method:"wallet_addEthereumChain",
          params:[{
            chainId: hex,
            chainName: "BNB Smart Chain",
            nativeCurrency: { name:"BNB", symbol:"BNB", decimals:18 },
            rpcUrls: [
              "https://bsc-dataseed.binance.org",
              "https://rpc.ankr.com/bsc",
              "https://bsc.publicnode.com"
            ],
            blockExplorerUrls:["https://bscscan.com"]
          }]
        });
      }else{
        throw e;
      }
    }
  }

  function fmt(v, d=4){
    try{
      return Number(v).toLocaleString("tr-TR", { maximumFractionDigits:d });
    }catch(_){ return String(v); }
  }

  /******************
   *  A K I Ş L A R *
   ******************/
  async function connectWallet(){
    try{
      say("Bağlanılıyor…");
      await ensureProvider();

      // Hesap iste
      const accounts = await window.ethereum.request({ method:"eth_requestAccounts" });
      user = ethers.utils.getAddress(accounts[0]);

      // BSC'ye geç
      await switchToBSC();

      // Token nesnesi ve decimals
      token  = new ethers.Contract(CONFIG.token, ERC20_ABI, signer);
      tokenDecimals = await token.decimals();

      $("#btn-connect").textContent = "Cüzdan Bağlı";
      $("#btn-connect").disabled = true;

      say(`Cüzdan bağlandı ✅\nHesap: ${user}\nAğ: BSC (56)\nToken: ${CONFIG.token}`);
    }catch(err){
      console.error(err);
      say(`Bağlantı hatası: ${err.message || err}`);
    }
  }

  async function buyNow(){
    try{
      if(!signer) throw new Error("Lütfen önce cüzdan bağla.");

      // Ağ ve hesap tekrar kontrol
      const net = await provider.getNetwork();
      if(Number(net.chainId) !== Number(CONFIG.chainId)){
        await switchToBSC();
      }

      // Bakiyeyi kontrol et
      const bal = await token.balanceOf(user);
      const need = ethers.utils.parseUnits(String(CONFIG.priceWTR), tokenDecimals);
      if(bal.lt(need)){
        throw new Error(`Yetersiz WTR bakiyesi. Gerekli: ${fmt(ethers.utils.formatUnits(need, tokenDecimals))} WTR`);
      }

      say("İşlem hazırlanıyor… MetaMask onayı bekleniyor.");
      const tx = await token.transfer(CONFIG.seller, need);
      say("İşlem gönderildi. Onay bekleniyor…\nTx: " + tx.hash);

      const rec = await tx.wait();
      add("Onay: " + rec.transactionHash);
      add("✅ Ödeme başarılı. İndirme açılıyor…");

      // Onay sonrası teslim — basit: gizli bağlantı
      // (Burasını kendi dosyanla değiştir: /public/downloads/kitap.pdf gibi)
      window.location.href = "../public/downloads/thanks.html";
    }catch(err){
      console.error(err);
      say(`Ödeme hatası: ${err.message || err}`);
    }
  }

  /******************
   *  E T K İ N L E R *
   ******************/
  $("#btn-connect").addEventListener("click", connectWallet);
  $("#btn-buy").addEventListener("click", buyNow);

  // Sayfayı açınca fiyat etiketini sabitle
  $("#price").textContent = String(CONFIG.priceWTR);
  </script>
</body>
</html>
